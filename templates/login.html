<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <link rel="stylesheet" href="{{ url_for('static', path='css/crearcuenta.css') }}">
    <link rel="icon" href="{{ url_for('static', path='img/logo-wind.svg') }}" class="icon-wind">
    <title>Iniciar Sesi√≥n | Aurum Joyer√≠a</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
      .forgot-link {
        display: block;
        text-align: right;
        margin-top: -8px;
        margin-bottom: 18px;
        color: #f9dc5e;
        font-size: 13px;
        cursor: pointer;
        font-family: 'Roboto Condensed', sans-serif;
        transition: opacity 0.2s;
        border: none;
        background: none;
        padding: 0;
      }
      .forgot-link:hover { opacity: 0.75; }

      /* ---- Modal overlay ---- */
      .r-overlay {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.92);
        justify-content: center;
        align-items: center;
        z-index: 10000;
      }
      .r-overlay.show { display: flex; }

      .r-box {
        background: linear-gradient(145deg, #1e1e1e, #2a2a2a);
        border: 2px solid #f9dc5e;
        border-radius: 20px;
        padding: 36px 40px 40px;
        max-width: 480px;
        width: 90%;
        animation: slideUp 0.28s ease;
      }
      @keyframes slideUp {
        from { transform: translateY(24px); opacity: 0; }
        to   { transform: translateY(0);    opacity: 1; }
      }
      .r-box h2 { color: #f9dc5e; margin: 0 0 8px; font-family: 'Roboto Condensed', sans-serif; font-size: 22px; }
      .r-box p  { color: #ccc; font-size: 14px; margin: 0 0 20px; line-height: 1.55; font-family: 'Roboto Condensed', sans-serif; }

      .r-input {
        width: 100%; padding: 12px 14px;
        background: #2a2a2a; border: 1px solid #444; border-radius: 8px;
        color: white; margin-bottom: 12px; font-size: 15px;
        box-sizing: border-box; font-family: 'Roboto Condensed', sans-serif;
        transition: border-color 0.2s;
      }
      .r-input:focus { outline: none; border-color: #f9dc5e; }

      .r-msg { display: none; padding: 11px 14px; border-radius: 8px; margin-bottom: 14px;
               font-size: 13px; line-height: 1.5; font-family: 'Roboto Condensed', sans-serif; }
      .r-msg.success { background: #1b5e20; color: #c8e6c9; }
      .r-msg.error   { background: #7f0000; color: #ffcdd2; }

      .btn-gold {
        width: 100%; padding: 13px;
        background: linear-gradient(45deg, #f9dc5e, #ffd700);
        color: #000; border: none; border-radius: 8px;
        font-weight: 700; font-size: 15px; cursor: pointer;
        font-family: 'Roboto Condensed', sans-serif;
        margin-bottom: 10px; transition: opacity 0.2s;
      }
      .btn-gold:hover:not(:disabled) { opacity: 0.88; }
      .btn-gold:disabled { opacity: 0.55; cursor: default; }

      .btn-ghost {
        width: 100%; padding: 11px; background: transparent;
        color: #aaa; border: 1px solid #444; border-radius: 8px;
        font-size: 14px; cursor: pointer; font-family: 'Roboto Condensed', sans-serif;
        transition: border-color 0.2s, color 0.2s;
      }
      .btn-ghost:hover { border-color: #f9dc5e; color: #f9dc5e; }

      .r-step { display: none; }
      .r-step.active { display: block; }

      .info-box {
        background: rgba(249,220,94,0.08); border-left: 3px solid #f9dc5e;
        padding: 11px 14px; border-radius: 6px; margin-bottom: 16px;
        font-size: 13px; color: #ccc; line-height: 1.5;
        font-family: 'Roboto Condensed', sans-serif;
      }
      .back-btn {
        display: inline-flex; align-items: center; gap: 5px;
        color: #aaa; font-size: 13px; cursor: pointer; margin-bottom: 16px;
        background: none; border: none; padding: 0;
        font-family: 'Roboto Condensed', sans-serif; transition: color 0.2s;
      }
      .back-btn:hover { color: #f9dc5e; }
    </style>
</head>
<body>

  <div class="registro-logo-wrapper">
    <a href="{{ url_for('index') }}">
      <img src="{{ url_for('static', path='img/logo.svg') }}" alt="Logo Aurum" class="registro-logo">
    </a>
  </div>

  <div class="registro-contenedor">
    <form class="registro-formulario" id="loginForm">
      <h2>Iniciar Sesi√≥n</h2>

      <div id="loginMessage" class="message-box" style="display: none;"></div>

      <input type="email" id="loginEmail" placeholder="Correo electr√≥nico" required autocomplete="email">

      <div class="password-container">
        <input type="password" id="loginPassword" placeholder="Contrase√±a" required autocomplete="current-password">
        <button type="button" class="toggle-password" tabindex="-1" data-target="loginPassword">
          <svg class="eye-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
          </svg>
          <svg class="eye-slash-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="display:none;">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"/>
          </svg>
        </button>
      </div>

      <!-- ‚úÖ LINK RECUPERACI√ìN (antes estaba en el HTML pero sin el elemento #forgotPasswordLink) -->
      <button type="button" class="forgot-link" id="forgotPasswordLink">¬øOlvidaste tu contrase√±a?</button>

      <button type="submit" id="loginBtn">Ingresar</button>

      <p class="login-link">¬øNo tienes cuenta? <a href="{{ url_for('register') }}">Reg√≠strate</a></p>
    </form>
  </div>

  <!-- ===== MODAL RECUPERACI√ìN ===== -->
  <div class="r-overlay" id="recoveryModal">
    <div class="r-box">

      <!-- Paso 1 -->
      <div class="r-step active" id="step1">
        <h2>üîë Recuperar contrase√±a</h2>
        <p>Ingresa tu correo y te enviaremos un c√≥digo para restablecer tu contrase√±a.</p>
        <div class="r-msg" id="msg1"></div>
        <input type="email" id="recoveryEmail" class="r-input" placeholder="Tu correo electr√≥nico" autocomplete="email">
        <button type="button" class="btn-gold" id="btnEnviarCodigo">Enviar c√≥digo</button>
        <button type="button" class="btn-ghost" id="btnCancelar">Cancelar</button>
      </div>

      <!-- Paso 2 -->
      <div class="r-step" id="step2">
        <button type="button" class="back-btn" id="btnVolver">‚Üê Volver</button>
        <h2>üîí Nueva contrase√±a</h2>
        <div class="info-box">
          Revisa tu bandeja de entrada (y la carpeta de spam). Copia el c√≥digo del correo y escribe tu nueva contrase√±a.
        </div>
        <div class="r-msg" id="msg2"></div>
        <input type="text"     id="resetCode"         class="r-input" placeholder="C√≥digo de recuperaci√≥n" autocomplete="off">
        <input type="password" id="newPassword"        class="r-input" placeholder="Nueva contrase√±a (m√≠nimo 6 caracteres)" autocomplete="new-password">
        <input type="password" id="newPasswordConfirm" class="r-input" placeholder="Confirmar nueva contrase√±a" autocomplete="new-password">
        <button type="button" class="btn-gold" id="btnRestablecer">Restablecer contrase√±a</button>
      </div>

    </div>
  </div>

  <script src="/static/js/api.js"></script>
  <script>
    // Toggle password
    document.querySelectorAll('.toggle-password').forEach(btn => {
      btn.addEventListener('click', function(e) {
        e.preventDefault(); e.stopPropagation();
        const inp = document.getElementById(this.dataset.target);
        const show = inp.type === 'password';
        inp.type = show ? 'text' : 'password';
        this.querySelector('.eye-icon').style.display      = show ? 'none' : '';
        this.querySelector('.eye-slash-icon').style.display = show ? ''    : 'none';
      });
      btn.addEventListener('mousedown', e => e.preventDefault());
    });

    // Redirect si logueado
    document.addEventListener('DOMContentLoaded', () => {
      const user = getCurrentUser();
      if (user) window.location.href = user.rol === 'admin' ? '/admin' : '/';
    });

    // === LOGIN ===
    document.getElementById('loginForm').addEventListener('submit', async e => {
      e.preventDefault();
      const email = document.getElementById('loginEmail').value.trim();
      const pass  = document.getElementById('loginPassword').value;
      const btn   = document.getElementById('loginBtn');

      if (!email || !pass) { showMsg('Completa todos los campos', 'error'); return; }

      btn.disabled = true; btn.textContent = 'Ingresando...';
      try {
        const res = await authAPI.login(email, pass);
        showMsg('¬°Bienvenido! Redirigiendo...', 'success');
        setTimeout(() => window.location.href = res.user.rol === 'admin' ? '/admin' : '/', 1000);
      } catch (err) {
        const msg = (err.message || '').includes('incorrectos') ? 'Email o contrase√±a incorrectos' : (err.message || 'Error al iniciar sesi√≥n');
        showMsg(msg, 'error');
        btn.disabled = false; btn.textContent = 'Ingresar';
      }
    });

    function showMsg(text, type) {
      const box = document.getElementById('loginMessage');
      box.textContent = text; box.className = `message-box ${type}`; box.style.display = 'block';
      if (type !== 'success') setTimeout(() => box.style.display = 'none', 5000);
    }

    // === MODAL ===
    const modal = document.getElementById('recoveryModal');
    const step1 = document.getElementById('step1');
    const step2 = document.getElementById('step2');

    const goStep = n => { step1.classList.toggle('active', n===1); step2.classList.toggle('active', n===2); };
    const showR  = (id, text, type) => { const el=document.getElementById(id); el.textContent=text; el.className=`r-msg ${type}`; el.style.display='block'; };
    const hideR  = id => { document.getElementById(id).style.display = 'none'; };

    // Abrir modal
    document.getElementById('forgotPasswordLink').addEventListener('click', () => {
      ['recoveryEmail','resetCode','newPassword','newPasswordConfirm'].forEach(id => document.getElementById(id).value='');
      hideR('msg1'); hideR('msg2'); goStep(1); modal.classList.add('show');
    });

    // Cerrar modal
    document.getElementById('btnCancelar').addEventListener('click', () => modal.classList.remove('show'));
    modal.addEventListener('click', e => { if (e.target===modal) modal.classList.remove('show'); });
    document.addEventListener('keydown', e => { if (e.key==='Escape') modal.classList.remove('show'); });

    // Volver
    document.getElementById('btnVolver').addEventListener('click', () => goStep(1));

    // Paso 1 ‚Äì enviar c√≥digo
    document.getElementById('btnEnviarCodigo').addEventListener('click', async () => {
      const email = document.getElementById('recoveryEmail').value.trim();
      const btn   = document.getElementById('btnEnviarCodigo');
      if (!email) { showR('msg1','Por favor ingresa tu email','error'); return; }
      if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) { showR('msg1','Email inv√°lido','error'); return; }

      btn.disabled=true; btn.textContent='Enviando...'; hideR('msg1');
      try {
        await authAPI.requestPasswordReset(email);
        showR('msg1','‚úÖ C√≥digo enviado. Revisa tu bandeja de entrada (puede tardar 1-2 minutos y llegar a spam).','success');
        setTimeout(() => goStep(2), 2600);
      } catch(err) {
        showR('msg1', err.message||'Error al enviar el c√≥digo', 'error');
      } finally {
        btn.disabled=false; btn.textContent='Enviar c√≥digo';
      }
    });
    document.getElementById('recoveryEmail').addEventListener('keydown', e => {
      if (e.key==='Enter') { e.preventDefault(); document.getElementById('btnEnviarCodigo').click(); }
    });

    // Paso 2 ‚Äì restablecer
    document.getElementById('btnRestablecer').addEventListener('click', async () => {
      const code  = document.getElementById('resetCode').value.trim();
      const pass1 = document.getElementById('newPassword').value;
      const pass2 = document.getElementById('newPasswordConfirm').value;
      const btn   = document.getElementById('btnRestablecer');

      if (!code||!pass1||!pass2) { showR('msg2','Completa todos los campos','error'); return; }
      if (pass1.length<6)        { showR('msg2','La contrase√±a debe tener al menos 6 caracteres','error'); return; }
      if (pass1!==pass2)          { showR('msg2','Las contrase√±as no coinciden','error'); return; }

      btn.disabled=true; btn.textContent='Restableciendo...'; hideR('msg2');
      try {
        await authAPI.resetPassword(code, pass1);
        showR('msg2','‚úÖ ¬°Contrase√±a restablecida! Ya puedes iniciar sesi√≥n.','success');
        setTimeout(() => {
          modal.classList.remove('show');
          showMsg('Contrase√±a actualizada. Inicia sesi√≥n con tu nueva contrase√±a.','success');
        }, 2500);
      } catch(err) {
        showR('msg2', err.message||'C√≥digo inv√°lido o expirado','error');
        btn.disabled=false; btn.textContent='Restablecer contrase√±a';
      }
    });
  </script>
</body>
</html>